name: Build Executables

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [published]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            asset_name: metar-service-linux
          - os: windows-latest
            name: windows
            asset_name: metar-service-windows.exe
          - os: macos-latest
            name: macos
            asset_name: metar-service-macos

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        # 创建临时构建脚本
        cat > build_temp.py << 'EOF'
import os
import sys

def build_executable():
    # 从环境变量获取 SPECIAL_MATER_API
    special_api = os.environ.get('SPECIAL_MATER_API')
    
    if not special_api:
        print("错误: 未设置 SPECIAL_MATER_API 环境变量")
        sys.exit(1)
    
    # 读取原始代码
    with open('main.py', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # 替换占位符
    content = content.replace('SPECIAL_MATER_API_PLACEHOLDER', special_api)
    
    # 写入临时文件
    with open('main_build.py', 'w', encoding='utf-8') as f:
        f.write(content)
    
    # 构建可执行文件
    output_name = "${{ matrix.asset_name }}"
    print(f"构建版本: {output_name}")
    
    # 使用 PyInstaller 构建
    os.system(f'pyinstaller --onefile --name "{output_name}" main_build.py')
    
    # 清理临时文件
    if os.path.exists('main_build.py'):
        os.remove('main_build.py')
    
    print("构建完成！")

if __name__ == '__main__':
    build_executable()
EOF

        # 运行构建脚本
        python build_temp.py
      env:
        SPECIAL_MATER_API: ${{ secrets.SPECIAL_MATER_API }}
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: dist/${{ matrix.asset_name }}
    
    - name: Create Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/${{ matrix.asset_name }}